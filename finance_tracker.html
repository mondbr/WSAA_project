<html>
    <head>
        <title> Personal Budget Tracker </title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <!--bootstrap CSS for styling, referred to AndrewBeatty code-->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    </head>
    <body>
      <!-- this is the title of the page -->
      <h1>Personal Budget Tracker</h1>
      
      <!-- this is the button to show the Create/Update form -->
      <div> 
         <button id="showCreateButton" onclick="showCreate()">Create New</button>
      </div>


      <!-- this is the button to show all transactions -->
      <div id="viewAllButtonDiv" style="display: block;">
         <button id="showViewAllButton" onclick="showViewAll()">View All Transactions</button>
      </div>

         <!-- this is the table to display transactions hidden at start, it is for creating anf updating transaction-->
      <div id="createUpdateForm" style= "display: none;">
         <h2><span id="createLabel">Create a</span> <span id="updateLabel">Update</span> Transaction</h2>
         Description: <input type="text" name="description" /><br/>
         Amount: <input type="number" name="amount"/> <br/>
         <!--dropdown for transaction type https://www.w3schools.com/tags/tag_select.asp-->
         Type: 
         <select name="transaction-type">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
         </select><br/>

         <!--buttons to create or update transactiion-->
         <button type="button" id="doCreateButton" onclick="doCreate()">Create</button>
         <button type="button" id="doUpdateButton" onclick="doUpdate()">Update</button>
      </div>

      <!--display list of transactions, referred to books in WSAA course-->
      <div id="transactionsTableDiv" style="display: none;">
         <h2>Transactions</h2>
         <!--table to display transactions in table with bold border https://www.w3schools.com/html/html_table_borders.asp-->
         <table id="transactionsTable" border="2 ">
            <thead>
               <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Type</th>
                  <th>Amount in USD</th>  <!-- New Column -->
                  <th>Exchange Rate</th> <!-- New Column -->
                  <th>Update</th>
                  <th>Delete</th>
               </tr>
            </thead>
            <tbody></tbody>
         </table>

         
      </div>

      <!--adding back button https://www.w3schools.com/tags/tag_button.asp-->
      <div id="backButtonDiv" style="display: none;">
         <button id="backButton" onclick="goBack()">Go back</button>
      </div>


      <script>
         //div element to be displayed or not https://www.w3schools.com/jsref/prop_style_display.asp

         // Function to show the create form and hide everything else
         function showCreate() {
             document.getElementById('showCreateButton').style.display = "none"; // Hide the Create New button
             document.getElementById('viewAllButtonDiv').style.display = "none"; // Hide View All button
             document.getElementById('createUpdateForm').style.display = "block"; // Show the create form
             document.getElementById('createLabel').style.display = "inline"; // Show Create label
             document.getElementById('updateLabel').style.display = "none"; // Hide Update label
             document.getElementById('doCreateButton').style.display = "block"; // Show Create button
             document.getElementById('doUpdateButton').style.display = "none"; // Hide Update button
         }
 
         // Function to show the transactions table and hide the form
         function showViewAll() {
             document.getElementById('showCreateButton').style.display = "block"; // Show Create button
             document.getElementById('createUpdateForm').style.display = "none"; // Hide the form
             document.getElementById('transactionsTableDiv').style.display = "block"; // Show the transactions table
             document.getElementById("backButtonDiv").style.display = "block"; // show the back button
             document.getElementById('viewAllButtonDiv').style.display = "none"; // Hide View All button
             
             fetchTransactions(); // Fetch transactions from the server
         }

         // Function to show the update form 
         function showUpdate(buttonElement) {
            document.getElementById('showCreateButton').style.display = "none"; // Hide Create button
            document.getElementById('createUpdateForm').style.display = "block"; // show the form
            document.getElementById('transactionsTableDiv').style.display = "none"; // Hide the transactions table
            document.getElementById('createLabel').style.display = "none"; // hide Create label
            document.getElementById('updateLabel').style.display = "inline"; // show Update label
            document.getElementById('doCreateButton').style.display = "none"; // Show Create button
            document.getElementById('doUpdateButton').style.display = "block"; // Hide Update button

            var rowElement = buttonElement.parentNode.parentNode; // Get the row element of the clicked button
            var transactionId = rowElement.getAttribute('id'); // Get the ID of the transaction
            
            document.querySelector('input[name="id"]').value = transactionId; // Set the ID in the form
            document.querySelector('input[name="description"]').value = rowElement.cells[0].innerHTML; // Set the description in the form
            document.querySelector('input[name="amount"]').value = rowElement.cells[1].innerHTML; // Set the amount in the form
            document.querySelector('select[name="transaction-type"]').value = rowElement.cells[2].innerHTML; // Set the transaction type in the form
           

         }

         // function to go back to the main page
         function goBack() {
            document.getElementById('showCreateButton').style.display = "block"; // Show Create button
            document.getElementById('createUpdateForm').style.display = "none"; // Hide the form
            document.getElementById('transactionsTableDiv').style.display = "none"; // Hide the transactions table
            document.getElementById("backButtonDiv").style.display = "none"; // hide the back button
            document.getElementById('viewAllButtonDiv').style.display = "block"; // Show the View All Transactions button again
         }
         // function to show all transactions from the database, referred to AndrewBeatty code
         function fetchTransactions() {
            $.ajax({
               url: "http://localhost:5000/transactions",
               method: "GET", // GET method to fetch all transactions
               //data: JSON.stringify(transaction), // data to be sent to the server
               dataType: "json",
               success: function(result) { // call back function if the request is succesful https://how.dev/answers/what-is-the-ajax-success-method
                  var tableBody = document.getElementById('transactionsTable').getElementsByTagName('tbody')[0]; // get the table body (tbody) of the element Transaction Table to insert rowns  https://www.w3schools.com/jsref/met_document_getelementsbytagname.asp
                  tableBody.innerHTML = ""; // Clear the table body to avoid appending old data https://stackoverflow.com/questions/15866451/how-to-clear-table-body-in-javascript

                  result.forEach(function(transaction) {
                     
                     var rowElement = tableBody.insertRow(); // insert new row https://stackoverflow.com/questions/15866451/how-to-insert-row-at-end-of-table-with-htmltableelement-insertrow
                     rowElement.setAttribute('id', transaction.id); // Set the ID of the row https://www.w3schools.com/jsref/met_element_setattribute.asp
                     rowElement.insertCell(0).innerHTML = transaction.description; // insert desription https://www.w3schools.com/jsref/met_table_insertrow.asp
                     rowElement.insertCell(1).innerHTML = transaction.amount; // insert amount
                     rowElement.insertCell(2).innerHTML = transaction.transaction_type; // insert transaction type
                     rowElement.insertCell(3).innerHTML = transaction.amount_in_usd || 'N/A'; // insert exchange rate
                     rowElement.insertCell(4).innerHTML = transaction.exchange_rate|| 'N/A'; // insert exchange rate
                     rowElement.insertCell(5).innerHTML = '<button onclick="showUpdate(this)">Update</button>'; // adding update button
                     rowElement.insertCell(6).innerHTML = '<button onclick="doDelete(this)">Delete</button>'; // adding delete button
                  });
                  
               },
               error: function(xhr, status, error) {
                  console.log("Error: " + status + " msg:" + error); // log the error message, referred to AndrewBeatty code
               }
            });

         }
 
         // Function to create a new transaction, referred to WSAA code
         function doCreate() {
             var form = document.getElementById('createUpdateForm');
             var transaction = {
                 description: form.querySelector('input[name="description"]').value,
                 amount: form.querySelector('input[name="amount"]').value,
                 transaction_type: form.querySelector('select[name="transaction-type"]').value
             };

             // calling the function to add the transaction to the table via Ajac
             createTransactionAjax(transaction);
         }
         // Function to send the transaction to the server via ajax
         function createTransactionAjax(transaction) {
            console.log(JSON.stringify(transaction)); 

            $.ajax({
               url: "http://localhost:5000/transactions",
               method: "POST", // POST method to create a new transaction
               data: JSON.stringify(transaction),
               dataType: "json",
               contentType: "application/json",
               success:function(result){
                  console.log(result); // log the result to check the data structure
                  transaction.id = result.id; 
                  addTransactionToTable(transaction); // Add the transaction to the table
                  clearForm(); // Clear the form
                  showViewAll(); // Show the transactions table
               },
               error:function(xhr, status, error){
                  console.log("Error: "+ status+ "msg:" + error);
               }
            });
         }
 
             
         // function to update a transaction
         function doUpdate(id) {

            var form = document.getElementById('createUpdateForm');
            var transaction = {
               id: form.querySelector('input[name="id"]').value, // Get the ID from the form
               description: form.querySelector('input[name="description"]').value,
               amount: form.querySelector('input[name="amount"]').value,
               transaction_type: form.querySelector('select[name="transaction-type"]').value
            }
         };

            $.ajax({
               url: "http://localhost:5000/transactions" + "/" + transactionId,
               method: "PUT", // PUT method to update a transaction
               data: JSON.stringify(transaction),
               dataType: "json",
               contentType: "application/json",
               success:function(result){
               // update the row in the table
                  var rowElement = document.getElementById(transactionId);
                  rowElement.cells[0].innerHTML = transaction.description; // Update description
                  rowElement.cells[1].innerHTML = transaction.amount; // Update amount
                  rowElement.cells[2].innerHTML = transaction.transaction_type; // Update transaction type

                  clearForm(); // Clear the form
                  showViewAll(); // Show the transactions table
                  goBack(); // Go back to the main page
                  },
            error:function(xhr, status, error){
               console.log("Error: "+ status+ "msg:" + error);
                  }
            });
         
         

 
         // Function to add a new transaction to the table
         function addTransactionToTable(transaction) {
             var tableElement = document.getElementById('transactionsTable').getElementsByTagName('tbody')[0];
             var rowElement = tableElement.insertRow();
 
             // Set the ID of the row 
             rowElement.setAttribute('id', transaction.id);
 
             // Insert transaction details into the table row
             rowElement.insertCell(0).innerHTML = transaction.description;
             rowElement.insertCell(1).innerHTML = transaction.amount;
             rowElement.insertCell(2).innerHTML = transaction.transaction_type;
 
             // Add Update and Delete buttons
             rowElement.insertCell(3).innerHTML = '<button onclick="showUpdate(this)">Update</button>';
             rowElement.insertCell(4).innerHTML = '<button onclick="doDelete(this)">Delete</button>';
         }
 
         // Function to clear the form after creating or updating a transaction
         function clearForm() {
             var form = document.getElementById('createUpdateForm');
             form.querySelector('input[name="description"]').value = '';
             form.querySelector('input[name="amount"]').value = '';
             form.querySelector('select[name="transaction-type"]').value = 'income';
         }
 
         // Function to delete a transaction
         function doDelete(r) {
             var rowElement = r.parentNode.parentNode;
             var transactionId = rowElement.getAttribute('id'); // Get the ID of the transaction
             
         

         // delete a transaction via ajax
               $.ajax({
                  url: "http://localhost:5000/transactions" + "/" + transactionId,
                  method: "DELETE", // DELETE method to delete a transaction
                  success: function() {
                   rowElement.remove(); // Remove the row from the table and show pop up message https://datatables.net/forums/discussion/42588/delete-specific-row-from-datatables
                     alert("Transaction deleted successfully");
                },
                  error: function(xhr, status, error) {
                   console.log("Error: " + status + " msg:" + error);
                }
             });
         }

         function getCurrencyExchangeRate() {
         // Replace YOUR_API_KEY with your actual FreeCurrencyAPI key
               const apiKey = 'YOUR_API_KEY';
               const url = `https://api.freecurrencyapi.com/v1/latest?apikey=${apiKey}&base_currency=EUR`; // EUR is the base currency, modify as needed

               $.ajax({
                  url: url,
                  method: 'GET',
                  success: function(response) {
                  // Log the result to check the data structure
                  console.log(response);

                  // Access the exchange rate for USD
                  const eurToUsdRate = response.data.USD; // This is assuming the API responds with data.USD

                  // Log the rate
                  console.log('Exchange rate EUR to USD:', eurToUsdRate);

                  // Now you can use this rate in your calculations, like for creating transactions
   },
                  error: function(xhr, status, error) {
                     console.log('Error fetching exchange rate:', error);
        }
    });
}

                  // Call the function to get the exchange rate
                  getCurrencyExchangeRate();




         
     </script>

      
    </body>
</html>